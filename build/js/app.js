var map;setTimeout(function(){map||$(".map-error").append("Google Map could not be loaded")},8e3),ko.bindingHandlers.googlemap={init:function(e){var t={zoom:13};map=new google.maps.Map(e,t)},update:function(e,t){var o=t(),n=o.mapCenter.latitude,a=o.mapCenter.longitude;map.setCenter({lat:n,lng:a})}};var infoWindowView=function(){var e='<div class="info-window" data-bind="with: currentVenue"><h2 class="window-header clickable" data-bind="text: name, click: selectVenue;"></h2><ul class="window-list" data-bind="foreach: concerts"><li class="window-list-element clickable" data-bind="click: selectEvent"><hr><h4 class="window-event-name" data-bind="text: title">blah</h4><p class="window-event-date date"><span data-bind="text: timeInfo.day"></span>, <span data-bind="text: timeInfo.date"></span></p></li></div>';return e=$.parseHTML(e)[0]},ViewModel=function(){function e(e,t){for(var o=0;o<t.length;o++)if(e===t[o].id)return o;return-1}function t(t){for(var o=[],n=0;n<t.length;n++){var a=e(t[n].venue.id,o),r=t[n].venue;-1===a?(r.concerts=[],r.concerts.push(t[n]),o.push(r),t[n].venueIndex=o.indexOf(r)):(t[n].venueIndex=a,o[a].concerts.push(t[n]))}return o}function o(e,t){return e=e.toLowerCase(),e.indexOf(t)>-1}function n(e,t){for(var n=0;n<e.length;n++)if(o(e[n],t))return!0}function a(e,t,o){localStorage&&(localStorage.setItem("lastAddress",e),localStorage.setItem("latitude",t),localStorage.setItem("longitude",o))}function r(e){for(var t=[],o=0;o<e.length;o++)"string"==typeof e[o].artists.artist&&(t.push(e[o].artists.artist),e[o].artists.artist=t,t=[]),e[o].tags||(e[o].tags={tag:[]}),"string"==typeof e[o].tags.tag&&(t.push(e[o].tags.tag),e[o].tags.tag=t,t=[]),e[o].timeInfo={day:e[o].startDate.substring(0,3),date:e[o].startDate.substring(5,11),year:e[o].startDate.substring(12,16),time:e[o].startDate.substring(17,22)}}function s(e){var t="https://api.foursquare.com/v2/venues/"+e+"?oauth_token=PV4PYPFODETGIN4BI22F1YN23FER1YPGAKQOBLCODUP251GX&v=20150702",o={success:function(e,t,o){console.log(e),u.currentVenueFourSquare(e.response.venue)},error:function(e,t,o){u.fourSquareStatus("Four Square data for venue could not be found.")},timeout:8e3};$.ajax(t,o)}var u=this;u.currentAddress=ko.observable(),u.mapCenter=ko.observable(),u.lastFmEvents=ko.observableArray(),u.lastFmVenues=ko.observableArray(),u.searchInput=ko.observable(),u.filteredEvents=ko.observableArray(),u.filteredVenues=ko.observableArray(),u.currentEvent=ko.observable(),u.currentVenue=ko.observable(),u.currentVenueFourSquare=ko.observable(),u.currentArtist=ko.observable(),u.currentArtistInfo=ko.observable(),u.currentArtistYoutube=ko.observableArray(),u.extraInfoBoolean=ko.observable(!0),u.showEventInfo=ko.observable(!1),u.showVenueInfo=ko.observable(!1),u.showArtistInfo=ko.observable(!1),u.displaySmallMenu=ko.observable(!1),u.hideLargeMenu=ko.observable(!1),u.listEvents=ko.observable(!0),u.listVenues=ko.observable(!1),u.geocoderStatus=ko.observable(),u.lastFmStatus=ko.observable(),u.lastFmArtistStatus=ko.observable(),u.fourSquareStatus=ko.observable(),u.youtubeStatus=ko.observable(),function(){if(localStorage.lastAddress&&localStorage.latitude&&localStorage.longitude){var e=Number(localStorage.latitude),t=Number(localStorage.longitude);u.currentAddress(localStorage.lastAddress),u.mapCenter({latitude:e,longitude:t})}else u.currentAddress("Austin, TX"),u.mapCenter({latitude:30.267153,longitude:-97.74306079999997})}(),u.currentArtistSearch=ko.computed(function(){var e;return u.currentArtist()&&(e=u.currentArtist().replace(/\s+/g,"+")),e}),u.showExtraInfo=ko.computed(function(){return(u.showEventInfo()||u.showVenueInfo()||u.showArtistInfo())&&u.extraInfoBoolean()?!0:!1}),u.buildAllVenues=ko.computed(function(){var e=u.lastFmEvents();u.lastFmVenues(t(e))}),u.mapMarkers=ko.computed(function(){var e=[],t=new google.maps.InfoWindow,o=u.lastFmVenues();console.log(o);for(var n=0;n<o.length;n++){var a=new google.maps.LatLng(o[n].location["geo:point"]["geo:lat"],o[n].location["geo:point"]["geo:long"]),r=new google.maps.Marker({position:a,title:o[n].name,content:infoWindowView(),icon:"images/red.png",map:map,venueIndex:n});google.maps.event.addListener(r,"mouseup",function(){var e=this;t.setContent(e.content),u.currentVenue(u.lastFmVenues()[e.venueIndex]),t.open(map,e),e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(google.maps.Animation["null"])},700)}),e.push(r),ko.applyBindings(u,r.content)}return e}),u.searchLastFmEvents=ko.computed(function(){if(u.searchInput()){for(var e,a=u.searchInput().toLowerCase(),r=[],s=0;s<u.lastFmEvents().length;s++){var i=u.lastFmEvents()[s];(o(i.venue.name,a)||o(i.venue.location.street,a)||o(i.title,a)||o(i.description,a)||n(i.artists.artist,a)||n(i.tags.tag,a))&&(r.push(i),e=t(r))}u.filteredEvents(r),u.filteredVenues(e)}else u.filteredEvents(u.lastFmEvents()),u.filteredVenues(u.lastFmVenues())}),u.mapMarkersSearch=ko.computed(function(){for(var e=u.lastFmVenues(),t=u.filteredEvents(),o=u.lastFmEvents(),n=0;n<e.length;n++){for(var a,r=0;r<e[n].concerts.length;r++)a=a||t.indexOf(e[n].concerts[r])>-1;u.mapMarkers()[n].setIcon(t===o?"images/red.png":a?"images/blue.png":"images/clear.png"),a=null}}),u.closeSmallMenu=function(){u.displaySmallMenu(!1)},u.openSmallMenu=function(){u.displaySmallMenu(!0)},u.toggleLargeMenu=function(){u.hideLargeMenu(u.hideLargeMenu()?!1:!0)},u.toggleExtraInfo=function(){u.extraInfoBoolean()?u.extraInfoBoolean(!1):(u.showEventInfo(!1),u.showVenueInfo(!1),u.showArtistInfo(!1),u.extraInfoBoolean(!0))},u.showEvents=function(){u.listEvents(!0),u.listVenues(!1)},u.showVenues=function(){u.listEvents(!1),u.listVenues(!0)},u.selectEvent=function(e){u.selectMarker(e.venueIndex),u.currentEvent(ko.mapping.fromJS(e)),u.showEventInfo(!0),u.showVenueInfo(!1),u.showArtistInfo(!1)},u.selectFilteredVenue=function(t){var o=e(t.id,u.lastFmVenues());u.selectVenue(u.lastFmVenues()[o])},u.selectVenue=function(e){var t=e||u.lastFmVenues()[u.currentEvent().venueIndex()];u.selectMarker(u.lastFmVenues.indexOf(t)),u.showVenueInfo(!0),u.showEventInfo(!1),u.showArtistInfo(!1)},u.selectArtist=function(e){u.currentArtist(e),u.showArtistInfo(!0),u.showEventInfo(!1),u.showVenueInfo(!1)},u.closeExtraInfo=function(){u.showEventInfo(!1),u.showVenueInfo(!1),u.showArtistInfo(!1)},u.selectMarker=function(e){google.maps.event.trigger(u.mapMarkers()[e],"mouseup"),map.panTo(u.mapMarkers()[e].position)};var i=new google.maps.Geocoder;u.getMapGeocode=ko.computed(function(){var e=setTimeout(function(){u.geocoderStatus("Location coordinates could not be loaded.")},8e3);i.geocode({address:u.currentAddress()},function(t,o){if(u.geocoderStatus("Setting map location..."),o==google.maps.GeocoderStatus.OK){clearTimeout(e),u.geocoderStatus(null);var n=t[0].geometry.location.G,r=t[0].geometry.location.K,s={latitude:n,longitude:r};n!=u.mapCenter().latitude&&r!=u.mapCenter().longitude&&(u.mapCenter(s),a(u.currentAddress(),n,r))}else u.geocoderStatus("Geocoder error because: "+o)})}),u.getLastFmEvents=ko.computed(function(){if(u.mapCenter().latitude&&u.mapCenter().longitude){var e=u.mapCenter().latitude,t=u.mapCenter().longitude,o="http://ws.audioscrobbler.com/2.0/?method=geo.getevents&lat="+e+"&long="+t+"&limit=100&api_key=d824cbbb7759624aa8b3621a627b70b8&format=json",n={success:function(e,t,o){u.mapMarkers().forEach(function(e){e.setMap(null)}),e.events?(u.lastFmStatus(null),r(e.events.event),u.lastFmEvents(e.events.event)):u.lastFmStatus(e.message)},error:function(){u.lastFmStatus("Last FM data could not be loaded. Please try again.")},timeout:11e3};u.lastFmEvents.removeAll(),u.lastFmStatus("Loading Last FM Data..."),$.ajax(o,n)}}),u.getArtistInfo=ko.computed(function(){if(u.currentArtistSearch()){var e="http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&artist="+u.currentArtistSearch()+"&api_key=d824cbbb7759624aa8b3621a627b70b8&format=json",t={success:function(e,t,o){u.lastFmArtistStatus(null),u.currentArtistInfo(ko.mapping.fromJS(e.artist))},error:function(){u.lastFmArtistStatus("Last FM artist data could not be loaded.")},timeout:8e3};u.lastFmArtistStatus("Loading Last FM artist data..."),$.ajax(e,t)}}),u.getArtistVideos=ko.computed(function(){if(u.currentArtistSearch()){var e="https://www.googleapis.com/youtube/v3/search?part=snippet&q="+u.currentArtistSearch()+"&key=AIzaSyA8B9NC0lW-vqhQzWmVp8XwEMFbyg01blI",t={success:function(e,t,o){for(var n=0;n<e.items.length;n++)e.items[n].url="https://www.youtube.com/watch?v="+e.items[n].id.videoId;u.youtubeStatus(null),u.currentArtistYoutube(e.items)},error:function(){u.youtubeStatus("Youtube search results could not be loaded.")},timeout:8e3};u.youtubeStatus("Loading Youtube search results..."),$.ajax(e,t)}}),u.findFourSquareVenue=ko.computed(function(){if(u.currentVenue()){var e=u.currentVenue().location["geo:point"]["geo:lat"],t=u.currentVenue().location["geo:point"]["geo:long"],o="https://api.foursquare.com/v2/venues/search?client_id=HEC4M2QKHJVGW5L5TPIBLBWBFJBBFSCIFFZDNZSGD2G5UGTI&client_secret=AJKA10FIBJE3CUKUBYYYOGZ0BU2XNGMXNGUA43LAI0PQT3ZD&v=20130815&ll="+e+","+t+"&query="+u.currentVenue().name+"&intent=match",n={success:function(e,t,o){e.response.venues.length>0?(s(e.response.venues[0].id),u.fourSquareStatus(null)):(u.currentVenueFourSquare(null),u.fourSquareStatus("Four Square data for venue could not be found."))},error:function(){u.fourSquareStatus("Four Square data for venue could not be loaded.")},timeout:8e3};u.fourSquareStatus("Loading Four Square data for venue..."),$.ajax(o,n)}})};ko.applyBindings(ViewModel);