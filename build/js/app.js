var map;setTimeout(function(){map||$(".map-error").append("Google Map could not be loaded")},8e3),ko.bindingHandlers.googlemap={init:function(e){var t={zoom:13};map=new google.maps.Map(e,t)},update:function(e,t){var n=t(),o=n.mapCenter.latitude,a=n.mapCenter.longitude;map.setCenter({lat:o,lng:a})}};var infoWindowView=function(){var e='<div class="info-window" data-bind="with: currentVenue"><h2 class="window-header clickable" data-bind="text: name, click: selectVenue;"></h2><ul class="window-list" data-bind="foreach: concerts"><li class="window-list-element clickable" data-bind="click: selectEvent"><hr><h4 class="window-event-name" data-bind="text: title">blah</h4><p class="window-event-date date"><span data-bind="text: timeInfo.day"></span>, <span data-bind="text: timeInfo.date"></span></p></li></div>';return e=$.parseHTML(e)[0]},ViewModel=function(){function e(){localStorage.lastLocation?(s.currentAddress=localStorage.lastLocation.address,s.mapCenter=localStorage.lastLocation.mapCenter):(s.currentAddress("Austin, TX"),s.mapCenter({latitude:30.267153,longitude:-97.74306079999997}))}function t(e,t){return e=e.toLowerCase(),e.indexOf(t)>-1}function n(e,n){for(var o=0;o<e.length;o++)if(t(e[o],n))return!0}function o(e,t){localStorage&&(localStorage.lastLocation.address=e,localStorage.lastLocation.mapCenter=t)}function a(e){for(var t=[],n=0;n<e.length;n++)"string"==typeof e[n].artists.artist&&(t.push(e[n].artists.artist),e[n].artists.artist=t,t=[]),e[n].tags||(e[n].tags={tag:[]}),"string"==typeof e[n].tags.tag&&(t.push(e[n].tags.tag),e[n].tags.tag=t,t=[]),e[n].timeInfo={day:e[n].startDate.substring(0,3),date:e[n].startDate.substring(5,11),year:e[n].startDate.substring(12,16),time:e[n].startDate.substring(17,22)}}function r(e){var t="https://api.foursquare.com/v2/venues/"+e+"?oauth_token=PV4PYPFODETGIN4BI22F1YN23FER1YPGAKQOBLCODUP251GX&v=20150702",n={success:function(e,t,n){console.log(e),s.currentVenueFourSquare(e.response.venue)},error:function(e,t,n){s.fourSquareStatus("Four Square data for venue could not be found.")},timeout:8e3};$.ajax(t,n)}var s=this;s.currentAddress=ko.observable(),s.mapCenter=ko.observable(),s.lastFmEvents=ko.observableArray(),s.lastFmVenues=ko.observableArray(),s.searchInput=ko.observable(),s.filteredEvents=ko.observableArray(),s.currentEvent=ko.observable(),s.currentVenue=ko.observable(),s.currentVenueFourSquare=ko.observable(),s.currentArtist=ko.observable(),s.currentArtistInfo=ko.observable(),s.currentArtistYoutube=ko.observableArray(),s.extraInfoBoolean=ko.observable(!0),s.showEventInfo=ko.observable(!1),s.showVenueInfo=ko.observable(!1),s.showArtistInfo=ko.observable(!1),s.displaySmallMenu=ko.observable(!1),s.hideLargeMenu=ko.observable(!1),s.listEvents=ko.observable(!0),s.listVenues=ko.observable(!1),s.geocoderStatus=ko.observable(),s.lastFmStatus=ko.observable(),s.lastFmArtistStatus=ko.observable(),s.fourSquareStatus=ko.observable(),s.youtubeStatus=ko.observable(),e(),s.currentArtistSearch=ko.computed(function(){var e;return s.currentArtist()&&(e=s.currentArtist().replace(/\s+/g,"+")),e}),s.showExtraInfo=ko.computed(function(){return(s.showEventInfo()||s.showVenueInfo()||s.showArtistInfo())&&s.extraInfoBoolean()?!0:!1}),s.newVenue=function(e,t){for(var n=0;n<t.length;n++)if(e===t[n].id)return n;return-1},s.buildVenues=ko.computed(function(){for(var e=s.lastFmEvents(),t=[],n=0;n<e.length;n++){var o=s.newVenue(e[n].venue.id,t),a=e[n].venue;-1===o?(a.concerts=[],a.concerts.push(e[n]),t.push(a),e[n].venueIndex=t.indexOf(a)):(e[n].venueIndex=o,t[o].concerts.push(e[n]))}s.lastFmVenues(t)}),s.mapMarkers=ko.computed(function(){var e=[],t=new google.maps.InfoWindow,n=s.lastFmVenues();console.log(n);for(var o=0;o<n.length;o++){var a=new google.maps.LatLng(n[o].location["geo:point"]["geo:lat"],n[o].location["geo:point"]["geo:long"]),r=new google.maps.Marker({position:a,title:n[o].name,content:infoWindowView(),icon:"images/red.png",map:map,venueIndex:o});google.maps.event.addListener(r,"mouseup",function(){t.setContent(this.content),s.currentVenue(s.lastFmVenues()[this.venueIndex]),t.open(map,this)}),e.push(r),ko.applyBindings(s,r.content)}return e}),s.searchLastFmEvents=ko.computed(function(){if(s.searchInput()){for(var e=s.searchInput().toLowerCase(),o=[],a=0;a<s.lastFmEvents().length;a++){var r=s.lastFmEvents()[a];(t(r.venue.name,e)||t(r.venue.location.street,e)||t(r.title,e)||t(r.description,e)||n(r.artists.artist,e)||n(r.tags.tag,e))&&o.push(r)}s.filteredEvents(o)}else s.filteredEvents(s.lastFmEvents())}),s.mapMarkersSearch=ko.computed(function(){for(var e=s.lastFmVenues(),t=(s.filteredEvents(),s.lastFmEvents(),0);t<e.length;t++){for(var n,o=0;o<e[t].concerts.length;o++)n=n||s.filteredEvents().indexOf(e[t].concerts[o])>-1;s.mapMarkers()[t].setIcon(s.filteredEvents()==s.lastFmEvents()?"images/red.png":n?"images/blue.png":"images/clear.png"),n=null}}),s.closeSmallMenu=function(){s.displaySmallMenu(!1)},s.openSmallMenu=function(){s.displaySmallMenu(!0)},s.toggleLargeMenu=function(){s.hideLargeMenu(s.hideLargeMenu()?!1:!0)},s.toggleExtraInfo=function(){s.extraInfoBoolean()?s.extraInfoBoolean(!1):(s.showEventInfo(!1),s.showVenueInfo(!1),s.showArtistInfo(!1),s.extraInfoBoolean(!0))},s.showEvents=function(){s.listEvents(!0),s.listVenues(!1)},s.showVenues=function(){s.listEvents(!1),s.listVenues(!0)},s.selectEvent=function(e){s.selectMarker(e.venueIndex),s.currentEvent(ko.mapping.fromJS(e)),s.showEventInfo(!0),s.showVenueInfo(!1),s.showArtistInfo(!1)},s.selectVenue=function(e){var t=e||s.lastFmVenues()[currentEvent().venueIndex()];s.selectMarker(lastFmVenues.indexOf(t)),s.showVenueInfo(!0),s.showEventInfo(!1),s.showArtistInfo(!1)},s.selectArtist=function(e){s.currentArtist(e),s.showArtistInfo(!0),s.showEventInfo(!1),s.showVenueInfo(!1)},s.closeExtraInfo=function(){s.showEventInfo(!1),s.showVenueInfo(!1),s.showArtistInfo(!1)},s.selectMarker=function(e){google.maps.event.trigger(s.mapMarkers()[e],"mouseup"),map.panTo(s.mapMarkers()[e].position)};var u=new google.maps.Geocoder;s.getMapGeocode=ko.computed(function(){var e=setTimeout(function(){s.geocoderStatus("Location coordinates could not be loaded.")},8e3);u.geocode({address:s.currentAddress()},function(t,n){if(s.geocoderStatus("Setting map location..."),n==google.maps.GeocoderStatus.OK){clearTimeout(e),s.geocoderStatus(null);var a=t[0].geometry.location.G,r=t[0].geometry.location.K,u={latitude:a,longitude:r};a!=s.mapCenter().latitude&&r!=s.mapCenter().longitude&&(s.mapCenter(u),o(s.currentAddress(),u))}else s.geocoderStatus("Geocoder error because: "+n)})}),s.getLastFmEvents=ko.computed(function(){if(s.mapCenter().latitude&&s.mapCenter().longitude){var e=s.mapCenter().latitude,t=s.mapCenter().longitude,n="http://ws.audioscrobbler.com/2.0/?method=geo.getevents&lat="+e+"&long="+t+"&limit=100&api_key=d824cbbb7759624aa8b3621a627b70b8&format=json",o={success:function(e,t,n){s.mapMarkers().forEach(function(e){e.setMap(null)}),e.events?(s.lastFmStatus(null),a(e.events.event),s.lastFmEvents(e.events.event)):s.lastFmStatus(e.message)},error:function(){s.lastFmStatus("Last FM data could not be loaded. Please try again.")},timeout:11e3};s.lastFmEvents.removeAll(),s.lastFmStatus("Loading Last FM Data..."),$.ajax(n,o)}}),s.getArtistInfo=ko.computed(function(){if(s.currentArtistSearch()){var e="http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&artist="+s.currentArtistSearch()+"&api_key=d824cbbb7759624aa8b3621a627b70b8&format=json",t={success:function(e,t,n){s.lastFmArtistStatus(null),s.currentArtistInfo(ko.mapping.fromJS(e.artist))},error:function(){s.lastFmArtistStatus("Last FM artist data could not be loaded.")},timeout:8e3};s.lastFmArtistStatus("Loading Last FM artist data..."),$.ajax(e,t)}}),s.getArtistVideos=ko.computed(function(){if(s.currentArtistSearch()){var e="https://www.googleapis.com/youtube/v3/search?part=snippet&q="+s.currentArtistSearch()+"&key=AIzaSyA8B9NC0lW-vqhQzWmVp8XwEMFbyg01blI",t={success:function(e,t,n){for(var o=0;o<e.items.length;o++)e.items[o].url="https://www.youtube.com/watch?v="+e.items[o].id.videoId;s.youtubeStatus(null),s.currentArtistYoutube(e.items)},error:function(){s.youtubeStatus("Youtube search results could not be loaded.")},timeout:8e3};s.youtubeStatus("Loading Youtube search results..."),$.ajax(e,t)}}),s.findFourSquareVenue=ko.computed(function(){if(s.currentVenue()){var e=s.currentVenue().location["geo:point"]["geo:lat"],t=s.currentVenue().location["geo:point"]["geo:long"],n="https://api.foursquare.com/v2/venues/search?client_id=HEC4M2QKHJVGW5L5TPIBLBWBFJBBFSCIFFZDNZSGD2G5UGTI&client_secret=AJKA10FIBJE3CUKUBYYYOGZ0BU2XNGMXNGUA43LAI0PQT3ZD&v=20130815&ll="+e+","+t+"&query="+s.currentVenue().name+"&intent=match",o={success:function(e,t,n){e.response.venues.length>0?(r(e.response.venues[0].id),s.fourSquareStatus(null)):(s.currentVenueFourSquare(null),s.fourSquareStatus("Four Square data for venue could not be found."))},error:function(){s.fourSquareStatus("Four Square data for venue could not be loaded.")},timeout:8e3};s.fourSquareStatus("Loading Four Square data for venue..."),$.ajax(n,o)}})};ko.applyBindings(ViewModel);