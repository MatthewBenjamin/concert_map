function infoWindowClose(){var e=infoWindow.getContent();e&&document.getElementsByClassName("info-window-container")[0].appendChild(e)}var map,defaultLatlng,defaultAddress;!function(){if(localStorage.lastAddress&&localStorage.latitude&&localStorage.longitude){var e=Number(localStorage.latitude),t=Number(localStorage.longitude);defaultAddress=localStorage.lastAddress,defaultLatlng={latitude:e,longitude:t}}else defaultAddress="Milwaukee, WI",defaultLatlng={latitude:43.07772111168133,longitude:-88.10023715}}(),setTimeout(function(){map||$(".map-error").append("Google Map could not be loaded")},8e3),ko.bindingHandlers.googlemap={init:function(e){var t=new google.maps.LatLng(defaultLatlng.latitude,defaultLatlng.longitude),o={center:t};map=new google.maps.Map(e,o)},update:function(e,t){var o=t();map.fitBounds(o.mapBounds)}};var infoWindow=new google.maps.InfoWindow;google.maps.event.addListener(infoWindow,"closeclick",infoWindowClose);var infoWindowView=function(){return html=document.getElementsByClassName("info-content")[0],html},ViewModel=function(){function e(e,t){for(var o=0;o<t.length;o++)if(e===t[o].id)return o;return-1}function t(t){for(var o,n,a=[],r=0;r<t.length;r++)o=e(t[r].venue.id,a),n=t[r].venue,o===-1?(n.concerts=[],n.concerts.push(t[r]),a.push(n),t[r].venueIndex=a.indexOf(n)):(t[r].venueIndex=o,a[o].concerts.push(t[r]));return a}function o(e,t){return e=e.toLowerCase(),e.indexOf(t)>-1}function n(e,t,n){for(var a=0;a<e.length;a++)if(o(e[a][n],t))return!0}function a(e,t){if(n(e,t,"name"))return!0;for(var a=0;a<e.length;a++)if(e[a].lastfm&&e[a].lastfm.artist&&(o(e[a].lastfm.artist.bio.content,t)||n(e[a].lastfm.artist.tags.tag,t,"name")))return!0}function r(e,t,o){localStorage&&(localStorage.setItem("lastAddress",e),localStorage.setItem("latitude",t),localStorage.setItem("longitude",o))}function s(e){for(var t,o,n,a=0;a<e.length;a++)"available"===e[a].ticket_status?e[a].tickets_available=!0:e[a].tickets_available=!1,n=e[a].artists.length,n>1?(n-=1,e[a].subtitle="& "+n+" more act",n>1&&(e[a].subtitle+="s")):e[a].subtitle=null,t=new Date(Date.parse(e[a].datetime)),o=t.toDateString(),e[a].timeInfo={day:o.substring(0,3),date:o.substring(4,10),year:t.getFullYear(),time:t.toUTCString().substring(17,22)}}function u(e){return e.mbid?"mbid="+e.mbid:"artist="+e.name}function l(e){var t=u(ko.mapping.toJS(e)),o={success:function(t,o,n){t.error?(e.lastfm.status=I,v.currentArtist(ko.mapping.fromJS(e))):(e.lastfm=t,e.lastfm.status=null,v.currentArtist(ko.mapping.fromJS(e)))},error:function(t,o,n){e.lastfm.status=I,v.currentArtist(ko.mapping.fromJS(e))},timeout:11e3};$.ajax(h+t,o)}function i(){for(var e,t,o=0;o<v.concerts().length;o++)for(var n=0;n<v.concerts()[o].artists.length;n++)t=u(v.concerts()[o].artists[n]),v.artistCount(v.artistCount()+1),function(o,n){e={success:function(e,t,a){e.error?v.concerts()[o].artists[n].lastfm.status=I:(v.concerts()[o].artists[n].lastfm=e,v.concerts()[o].artists[n].lastfm.status=null)},error:function(e,t,a){v.concerts()[o].artists[n].lastfm.status=I},complete:function(e,t){console.log(t),v.artistCount(v.artistCount()-1)},timeout:11e3},v.concerts()[o].artists[n].lastfm={},$.ajax(h+t,e)}(o,n)}function c(e){var t="https://www.googleapis.com/youtube/v3/search?part=snippet&q="+e+"&key=AIzaSyA8B9NC0lW-vqhQzWmVp8XwEMFbyg01blI",o={success:function(e,t,o){for(var n=e.items,a=0;a<n.length;a++)n[a].url="https://www.youtube.com/watch?v="+n[a].id.videoId;v.youtubeStatus(null),v.currentArtistYoutube(n),v.currentArtist().youTube=n},error:function(){v.youtubeStatus("Youtube search results could not be loaded.")},timeout:8e3};v.youtubeStatus("Loading Youtube search results..."),$.ajax(t,o)}function d(e){return v.currentVenue()===v.concertVenues()[e]}function f(e,t){var o=new google.maps.places.PlacesService(map),n={placeId:e};o.getDetails(n,function(e,o){o==google.maps.places.PlacesServiceStatus.OK&&d(t)?(v.concertVenues()[t].detailedInfo.googlePlaces=e,v.currentVenuePlaces(e),v.venueInfoStatus(null)):(v.venueInfoStatus(venueInfoStatus),console.log(e,o))})}function g(e){venueName=v.currentVenue().name,latitude=v.currentVenue().latitude,longitude=v.currentVenue().longitude;var t=new google.maps.places.PlacesService(map),o=new google.maps.LatLng(latitude,longitude),n={location:o,query:venueName,radius:"1"};t.textSearch(n,function(t,o){o==google.maps.places.PlacesServiceStatus.OK?f(t[0].place_id,e):(v.venueInfoStatus(k),console.log(o,t))})}function m(e,t){var o="https://api.foursquare.com/v2/venues/"+e+"?oauth_token=PV4PYPFODETGIN4BI22F1YN23FER1YPGAKQOBLCODUP251GX&v=20160105",n={success:function(e,o,n){d(t)&&(v.concertVenues()[t].detailedInfo.fourSquare=e.response.venue,v.currentVenueFourSquare(e.response.venue),v.venueInfoStatus(null))},error:function(e,o,n){v.venueInfoStatus(S),g(t)},timeout:8e3};$.ajax(o,n)}function p(e){var t=v.concertVenues().indexOf(e),o=e.latitude,n=e.longitude,a="https://api.foursquare.com/v2/venues/search?client_id=HEC4M2QKHJVGW5L5TPIBLBWBFJBBFSCIFFZDNZSGD2G5UGTI&client_secret=AJKA10FIBJE3CUKUBYYYOGZ0BU2XNGMXNGUA43LAI0PQT3ZD&v=20160105&m=foursquare&ll="+o+","+n+"&query="+e.name+"&intent=match",r={success:function(e,o,n){e.response.venues.length>0&&d(t)?m(e.response.venues[0].id,t):(v.venueInfoStatus(S),g(t))},error:function(e,o,n){v.venueInfoStatus(S),g(t)},timeout:8e3};e.detailedInfo={},v.venueInfoStatus("Loading Four Square data for venue..."),$.ajax(a,r)}var v=this;v.currentAddress=ko.observable(defaultAddress),v.mapCenter=ko.observable(defaultLatlng),v.concerts=ko.observableArray(),v.concertVenues=ko.observableArray(),v.searchInput=ko.observable(),v.filteredEvents=ko.observableArray(),v.filteredVenues=ko.observableArray(),v.currentEvent=ko.observable(),v.currentVenue=ko.observable(),v.currentArtist=ko.observable(),v.currentArtistYoutube=ko.observableArray(),v.currentVenueFourSquare=ko.observable(),v.currentVenuePlaces=ko.observable(),v.extraInfoBoolean=ko.observable(!0),v.showEventInfo=ko.observable(!1),v.showVenueInfo=ko.observable(!1),v.showArtistInfo=ko.observable(!1),v.showMenu=ko.observable(!0),v.listEvents=ko.observable(!0),v.listVenues=ko.observable(!1),v.geocoderStatus=ko.observable(),v.concertsStatus=ko.observable(),v.venueInfoStatus=ko.observable(),v.youtubeStatus=ko.observable(),v.showExtraInfo=ko.computed(function(){return!(!(v.showEventInfo()||v.showVenueInfo()||v.showArtistInfo())||!v.extraInfoBoolean())}),v.buildAllVenues=ko.computed(function(){var e=v.concerts();v.concertVenues(t(e))}),v.mapMarkers=ko.computed(function(){for(var e=[],t=v.concertVenues(),o=0;o<t.length;o++){var n=new google.maps.LatLng(t[o].latitude,t[o].longitude),a=new google.maps.Marker({position:n,title:t[o].name,icon:"images/red.png",map:map,venueIndex:o});google.maps.event.addListener(a,"mouseup",function(){var e=this;infoWindow.setContent(infoWindowView()),v.currentVenue(v.concertVenues()[e.venueIndex]),infoWindow.open(map,e),e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(google.maps.Animation["null"])},700)}),e.push(a)}return e}),v.mapBounds=ko.observable(),v.findMapBounds=ko.computed(function(){for(var e=v.mapMarkers(),t=new google.maps.LatLngBounds,o=0;o<e.length;o++)t.extend(e[o].getPosition());v.mapBounds(t)}),v.searchConcerts=ko.computed(function(){if(v.searchInput()){for(var e,n,r=v.searchInput().toLowerCase(),s=[],u=0;u<v.concerts().length;u++)n=v.concerts()[u],(o(n.venue.name,r)||o(n.venue.city,r)||a(n.artists,r))&&s.push(n);e=t(s),v.filteredEvents(s),v.filteredVenues(e)}else t(v.concerts()),v.filteredEvents(v.concerts()),v.filteredVenues(v.concertVenues())}),v.mapMarkersSearch=ko.computed(function(){for(var e=v.concertVenues(),t=v.filteredEvents(),o=v.concerts(),n=0;n<e.length;n++){for(var a,r=0;r<e[n].concerts.length;r++)a=a||t.indexOf(e[n].concerts[r])>-1;t===o?v.mapMarkers()[n].setIcon("images/red.png"):a?v.mapMarkers()[n].setIcon("images/blue.png"):v.mapMarkers()[n].setIcon("images/clear.png"),a=null}}),v.toggleMenu=function(){v.showMenu()?v.showMenu(!1):v.showMenu(!0)},v.toggleExtraInfo=function(){v.extraInfoBoolean()?v.extraInfoBoolean(!1):(v.showEventInfo(!1),v.showVenueInfo(!1),v.showArtistInfo(!1),v.extraInfoBoolean(!0))},v.showEvents=function(){v.listEvents(!0),v.listVenues(!1)},v.showVenues=function(){v.listEvents(!1),v.listVenues(!0)},v.backToEvent=function(e){selectEvent(ko.mapping.toJS(e))},v.selectEvent=function(t){var o=e(t.venue.id,v.concertVenues());v.selectMarker(o),v.currentEvent(ko.mapping.fromJS(t)),v.showEventInfo(!0),v.showVenueInfo(!1),v.showArtistInfo(!1)},v.selectFilteredVenue=function(t){var o=e(t.id,v.concertVenues());v.selectVenue(v.concertVenues()[o])},v.selectVenue=function(e){var t=e||v.concertVenues()[v.currentEvent().venueIndex()];v.selectMarker(v.concertVenues.indexOf(t)),v.showVenueInfo(!0),v.showEventInfo(!1),v.showArtistInfo(!1)},v.selectArtist=function(e){v.currentArtist(e),v.showArtistInfo(!0),v.showEventInfo(!1),v.showVenueInfo(!1)},v.closeExtraInfo=function(){v.showEventInfo(!1),v.showVenueInfo(!1),v.showArtistInfo(!1)},v.selectMarker=function(e){google.maps.event.trigger(v.mapMarkers()[e],"mouseup"),map.panTo(v.mapMarkers()[e].position)};var b=new google.maps.Geocoder;v.getMapGeocode=ko.computed(function(){if(defaultAddress!=v.currentAddress()){var e=setTimeout(function(){v.geocoderStatus("Location coordinates could not be loaded.")},8e3);b.geocode({address:v.currentAddress()},function(t,o){if(v.geocoderStatus("Setting map location..."),o==google.maps.GeocoderStatus.OK){clearTimeout(e),v.geocoderStatus(null);var n=t[0].geometry.location.lat(),a=t[0].geometry.location.lng(),s={latitude:n,longitude:a};s!=v.mapCenter()&&(console.log("map center: ",s),console.log("self center: ",v.mapCenter()),v.mapCenter(s),r(v.currentAddress(),n,a),defaultLatlng={latitude:n,longitude:a})}else v.geocoderStatus("Geocoder error because: "+o)})}}),v.getConcerts=ko.computed(function(){if(0===v.concerts().length&&v.mapCenter()===defaultLatlng||v.concerts().length>0&&v.mapCenter().latitude!==defaultLatlng.latitude&&v.mapCenter().longitude!==defaultLatlng.longitude){var e=v.mapCenter().latitude,t=v.mapCenter().longitude,o="http://api.bandsintown.com/events/search.json?api_version=2.0&app_id=google-map-mashup&location="+e+","+t+"&per_page=100&format=json",n={dataType:"jsonp",crossDomain:"true",success:function(e,t,o){v.mapMarkers().forEach(function(e){e.setMap(null)}),e&&(v.concertsStatus(null),s(e),v.concerts(e))},error:function(){v.concertsStatus("Concert data could not be loaded. Please try again.")},timeout:11e3};v.concertsStatus("Loading Concert Data..."),$.ajax(o,n)}});var h="http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&api_key=d824cbbb7759624aa8b3621a627b70b8&format=json&",I="Sorry, additional information from Last.fm could not be loaded.";v.getArtistInfo=ko.computed(function(){var e=v.currentArtist();e&&!e.lastfm&&(e.lastfm={},e.lastfm.status="Loading detailed artist info...",l(e))}),v.requestAllArtistInfo=ko.observable(!1),v.artistCount=ko.observable(0),v.allArtistStatusUpdate=ko.computed(function(){return 0===v.artistCount()?null:v.artistCount()>0?"Searching for Artist Info...":void 0}),v.searchBarFocus=ko.observable(!1),v.manualToggle=ko.observable(!1),v.anotherToggle=ko.computed(function(){v.searchBarFocus()&&v.manualToggle(!0)}),v.dontAsk=ko.observable(!1),v.askForArtistInfo=ko.computed(function(){return!v.dontAsk()&&(!(!searchBarFocus()&&!manualToggle())||void 0)}),v.getAllArtistInfo=ko.computed(function(){v.requestAllArtistInfo()&&(v.requestAllArtistInfo(!1),i())}),searchableName=function(e){return e=e.replace(/\s+/g,"+")},v.getArtistVideos=ko.computed(function(){var e=v.currentArtist();if(e)if(e.youTube)v.youtubeStatus(null),v.currentArtistYoutube(e.youTube);else{v.currentArtistYoutube(null);var t=searchableName(e.name());c(t)}});var k="Sorry, detailed venue information could not be loaded.",S="Four Square data cannot be found. Loading Google Places data instead...";v.loadDetailedVenueInfo=ko.computed(function(){var e=v.currentVenue();e&&(v.currentVenuePlaces(null),v.currentVenueFourSquare(null),e.detailedInfo?e.detailedInfo.fourSquare?v.currentVenueFourSquare(e.detailedInfo.fourSquare):e.detailedInfo.googlePlaces?v.currentVenuePlaces(e.detailedInfo.googlePlaces):v.venueInfoStatus(k):p(e))})};ko.applyBindings(ViewModel);