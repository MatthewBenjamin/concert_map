var map;setTimeout(function(){map||$(".map-error").append("Google Map could not be loaded")},8e3),ko.bindingHandlers.googlemap={init:function(e){var t={zoom:13};map=new google.maps.Map(e,t)},update:function(e,t){var n=t(),o=n.mapCenter.latitude,a=n.mapCenter.longitude;map.setCenter({lat:o,lng:a}),map.fitBounds(n.mapBounds)}};var infoWindowView=function(){var e='<div class="info-window" data-bind="with: currentVenue"><h2 class="window-header clickable" data-bind="text: name, click: selectVenue;"></h2><ul class="window-list" data-bind="foreach: concerts"><li class="window-list-element clickable" data-bind="click: selectEvent"><hr><p><span class="bold" data-bind="text: artists[0].name"></span> <span class="italic" data-bind="text: subtitle"></span></p><p class="window-event-date date"><span data-bind="text: timeInfo.day"></span>, <span data-bind="text: timeInfo.date"></span></p></li></div>';return e=$.parseHTML(e)[0]},ViewModel=function(){function e(e,t){for(var n=0;n<t.length;n++)if(e===t[n].id)return n;return-1}function t(t){for(var n,o,a=[],r=0;r<t.length;r++)n=e(t[r].venue.id,a),o=t[r].venue,-1===n?(o.concerts=[],o.concerts.push(t[r]),a.push(o),t[r].venueIndex=a.indexOf(o)):(t[r].venueIndex=n,a[n].concerts.push(t[r]));return a}function n(e,t){return e=e.toLowerCase(),e.indexOf(t)>-1}function o(e,t,o){for(var a=0;a<e.length;a++)if(n(e[a][o],t))return!0}function a(e,t){if(o(e,t,"name"))return!0;for(var a=0;a<e.length;a++)if(e[a].lastfm.artist&&(n(e[a].lastfm.artist.bio.content,t)||o(e[a].lastfm.artist.tags.tag,t,"name")))return!0}function r(e,t,n){localStorage&&(localStorage.setItem("lastAddress",e),localStorage.setItem("latitude",t),localStorage.setItem("longitude",n))}function s(e){for(var t,n,o,a=0;a<e.length;a++)"available"===e[a].ticket_status?e[a].tickets_available=!0:e[a].tickets_available=!1,o=e[a].artists.length,o>1?(o-=1,e[a].subtitle="& "+o+" more act",o>1&&(e[a].subtitle+="s")):e[a].subtitle=null,t=new Date(Date.parse(e[a].datetime)),n=t.toDateString(),e[a].timeInfo={day:n.substring(0,3),date:n.substring(4,10),year:t.getFullYear(),time:t.toUTCString().substring(17,22)}}function u(e){var t="https://www.googleapis.com/youtube/v3/search?part=snippet&q="+e+"&key=AIzaSyA8B9NC0lW-vqhQzWmVp8XwEMFbyg01blI",n={success:function(e,t,n){for(var o=e.items,a=0;a<o.length;a++)o[a].url="https://www.youtube.com/watch?v="+o[a].id.videoId;g.youtubeStatus(null),g.currentArtistYoutube(o),g.currentArtist().youTube=o},error:function(){g.youtubeStatus("Youtube search results could not be loaded.")},timeout:8e3};g.youtubeStatus("Loading Youtube search results..."),$.ajax(t,n)}function c(e){return g.currentVenue()===g.concertVenues()[e]?!0:!1}function i(e,t){var n=new google.maps.places.PlacesService(map),o={placeId:e};n.getDetails(o,function(e,n){n==google.maps.places.PlacesServiceStatus.OK&&c(t)?(g.concertVenues()[t].detailedInfo.googlePlaces=e,g.currentVenuePlaces(e),g.venueInfoStatus(null)):console.log(e,n)})}function l(e){venueName=g.currentVenue().name,latitude=g.currentVenue().latitude,longitude=g.currentVenue().longitude;var t=new google.maps.places.PlacesService(map),n=new google.maps.LatLng(latitude,longitude),o={location:n,query:venueName,radius:"1"};t.textSearch(o,function(t,n){n==google.maps.places.PlacesServiceStatus.OK?i(t[0].place_id,e):(g.venueInfoStatus(p),console.log(n,t))})}function d(e,t){var n="https://api.foursquare.com/v2/venues/"+e+"?oauth_token=PV4PYPFODETGIN4BI22F1YN23FER1YPGAKQOBLCODUP251GX&v=20160105",o={success:function(e,n,o){c(t)&&(g.concertVenues()[t].detailedInfo.fourSquare=e.response.venue,g.currentVenueFourSquare(e.response.venue),g.venueInfoStatus(null))},error:function(e,n,o){g.venueInfoStatus(v),l(t)},timeout:8e3};$.ajax(n,o)}function f(e){var t=e.concerts[0].venueIndex,n=e.latitude,o=e.longitude,a="https://api.foursquare.com/v2/venues/search?client_id=HEC4M2QKHJVGW5L5TPIBLBWBFJBBFSCIFFZDNZSGD2G5UGTI&client_secret=AJKA10FIBJE3CUKUBYYYOGZ0BU2XNGMXNGUA43LAI0PQT3ZD&v=20160105&m=foursquare&ll="+n+","+o+"&query="+e.name+"&intent=match",r={success:function(e,n,o){e.response.venues.length>0&&c(t)?d(e.response.venues[0].id,t):(g.venueInfoStatus(v),l(t))},error:function(e,n,o){g.venueInfoStatus(v),l(t)},timeout:8e3};e.detailedInfo={},g.venueInfoStatus("Loading Four Square data for venue..."),$.ajax(a,r)}var g=this;g.currentAddress=ko.observable(),g.mapCenter=ko.observable(),g.concerts=ko.observableArray(),g.concertVenues=ko.observableArray(),g.searchInput=ko.observable(),g.filteredEvents=ko.observableArray(),g.filteredVenues=ko.observableArray(),g.currentEvent=ko.observable(),g.currentVenue=ko.observable(),g.currentArtist=ko.observable(),g.currentArtistYoutube=ko.observableArray(),g.currentVenueFourSquare=ko.observable(),g.currentVenuePlaces=ko.observable(),g.extraInfoBoolean=ko.observable(!0),g.showEventInfo=ko.observable(!1),g.showVenueInfo=ko.observable(!1),g.showArtistInfo=ko.observable(!1),g.displaySmallMenu=ko.observable(!1),g.hideLargeMenu=ko.observable(!1),g.listEvents=ko.observable(!0),g.listVenues=ko.observable(!1),g.geocoderStatus=ko.observable(),g.concertsStatus=ko.observable(),g.venueInfoStatus=ko.observable(),g.youtubeStatus=ko.observable(),function(){if(localStorage.lastAddress&&localStorage.latitude&&localStorage.longitude){var e=Number(localStorage.latitude),t=Number(localStorage.longitude);g.currentAddress(localStorage.lastAddress),g.mapCenter({latitude:e,longitude:t})}else g.currentAddress("Austin, TX"),g.mapCenter({latitude:30.267153,longitude:-97.74306079999997})}(),g.showExtraInfo=ko.computed(function(){return(g.showEventInfo()||g.showVenueInfo()||g.showArtistInfo())&&g.extraInfoBoolean()?!0:!1}),g.buildAllVenues=ko.computed(function(){var e=g.concerts();g.concertVenues(t(e))}),g.mapMarkers=ko.computed(function(){for(var e=[],t=new google.maps.InfoWindow,n=g.concertVenues(),o=0;o<n.length;o++){var a=new google.maps.LatLng(n[o].latitude,n[o].longitude),r=new google.maps.Marker({position:a,title:n[o].name,content:infoWindowView(),icon:"images/red.png",map:map,venueIndex:o});google.maps.event.addListener(r,"mouseup",function(){var e=this;t.setContent(e.content),g.currentVenue(g.concertVenues()[e.venueIndex]),t.open(map,e),e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(google.maps.Animation["null"])},700)}),e.push(r),ko.applyBindings(g,r.content)}return e}),g.mapBounds=ko.observable(),g.findMapBounds=ko.computed(function(){for(var e=g.mapMarkers(),t=new google.maps.LatLngBounds,n=0;n<e.length;n++)t.extend(e[n].getPosition());g.mapBounds(t)}),g.searchConcerts=ko.computed(function(){if(g.searchInput()){for(var e,o,r=g.searchInput().toLowerCase(),s=[],u=0;u<g.concerts().length;u++)o=g.concerts()[u],(n(o.venue.name,r)||n(o.venue.city,r)||a(o.artists,r))&&s.push(o);e=t(s),g.filteredEvents(s),g.filteredVenues(e)}else t(g.concerts()),g.filteredEvents(g.concerts()),g.filteredVenues(g.concertVenues())}),g.mapMarkersSearch=ko.computed(function(){for(var e=g.concertVenues(),t=g.filteredEvents(),n=g.concerts(),o=0;o<e.length;o++){for(var a,r=0;r<e[o].concerts.length;r++)a=a||t.indexOf(e[o].concerts[r])>-1;t===n?g.mapMarkers()[o].setIcon("images/red.png"):a?g.mapMarkers()[o].setIcon("images/blue.png"):g.mapMarkers()[o].setIcon("images/clear.png"),a=null}}),g.closeSmallMenu=function(){g.displaySmallMenu(!1)},g.openSmallMenu=function(){g.displaySmallMenu(!0)},g.toggleLargeMenu=function(){g.hideLargeMenu()?g.hideLargeMenu(!1):g.hideLargeMenu(!0)},g.toggleExtraInfo=function(){g.extraInfoBoolean()?g.extraInfoBoolean(!1):(g.showEventInfo(!1),g.showVenueInfo(!1),g.showArtistInfo(!1),g.extraInfoBoolean(!0))},g.showEvents=function(){g.listEvents(!0),g.listVenues(!1)},g.showVenues=function(){g.listEvents(!1),g.listVenues(!0)},g.backToEvent=function(e){selectEvent(ko.mapping.toJS(e))},g.selectEvent=function(e){g.selectMarker(e.venueIndex),g.currentEvent(ko.mapping.fromJS(e)),g.showEventInfo(!0),g.showVenueInfo(!1),g.showArtistInfo(!1)},g.selectFilteredVenue=function(t){var n=e(t.id,g.concertVenues());g.selectVenue(g.concertVenues()[n])},g.selectVenue=function(e){var t=e||g.concertVenues()[g.currentEvent().venueIndex()];g.selectMarker(g.concertVenues.indexOf(t)),g.showVenueInfo(!0),g.showEventInfo(!1),g.showArtistInfo(!1)},g.selectArtist=function(e){g.currentArtist(e),g.showArtistInfo(!0),g.showEventInfo(!1),g.showVenueInfo(!1)},g.closeExtraInfo=function(){g.showEventInfo(!1),g.showVenueInfo(!1),g.showArtistInfo(!1)},g.selectMarker=function(e){google.maps.event.trigger(g.mapMarkers()[e],"mouseup"),map.panTo(g.mapMarkers()[e].position)};var m=new google.maps.Geocoder;g.getMapGeocode=ko.computed(function(){var e=setTimeout(function(){g.geocoderStatus("Location coordinates could not be loaded.")},8e3);m.geocode({address:g.currentAddress()},function(t,n){if(g.geocoderStatus("Setting map location..."),n==google.maps.GeocoderStatus.OK){clearTimeout(e),g.geocoderStatus(null);var o=t[0].geometry.location.lat(),a=t[0].geometry.location.lng(),s={latitude:o,longitude:a};s!=g.mapCenter()&&(g.mapCenter(s),r(g.currentAddress(),o,a))}else g.geocoderStatus("Geocoder error because: "+n)})}),g.getConcerts=ko.computed(function(){if(g.mapCenter().latitude&&g.mapCenter().longitude){var e=g.mapCenter().latitude,t=g.mapCenter().longitude,n="http://api.bandsintown.com/events/search.json?app_id=google-map-mashup&location="+e+","+t+"&per_page=100&format=json",o={dataType:"jsonp",crossDomain:"true",success:function(e,t,n){g.mapMarkers().forEach(function(e){e.setMap(null)}),e&&(g.concertsStatus(null),s(e),g.concerts(e))},error:function(){g.concertsStatus("Concert data could not be loaded. Please try again.")},timeout:11e3};g.concertsStatus("Loading Concert Data..."),$.ajax(n,o)}}),g.getArtistInfo=ko.computed(function(){console.log("Searching for Artist Info...");for(var e,t,n="http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&api_key=d824cbbb7759624aa8b3621a627b70b8&format=json&",o=0;o<g.concerts().length;o++){for(var a=0;a<g.concerts()[o].artists.length;a++)t=g.concerts()[o].artists[a].mbid?"mbid="+g.concerts()[o].artists[a].mbid:"artist="+g.concerts()[o].artists[a].name,function(o,a){var r="Sorry, but additional information about this artist from Last.fm could not be loaded.";e={success:function(e,t,n){e.error?g.concerts()[o].artists[a].lastfm.error=r:(g.concerts()[o].artists[a].lastfm=e,g.concerts()[o].artists[a].lastfm.error=null)},error:function(e,t,n){g.concerts()[o].artists[a].lastfm.error=r},timeout:11e3},g.concerts()[o].artists[a].lastfm={},$.ajax(n+t,e)}(o,a);o==g.concerts().length-1&&console.log("artist search completed(sort of...)")}}),searchableName=function(e){return e=e.replace(/\s+/g,"+")},g.getArtistVideos=ko.computed(function(){var e=g.currentArtist();if(e)if(e.youTube)g.youtubeStatus(null),g.currentArtistYoutube(e.youTube);else{g.currentArtistYoutube(null);var t=searchableName(e.name());u(t)}});var p="Sorry, detailed venue information could not be loaded.",v="Four Square data cannot be found. Loading Google Places data instead...";g.loadDetailedVenueInfo=ko.computed(function(){var e=g.currentVenue();e&&(g.currentVenuePlaces(null),g.currentVenueFourSquare(null),e.detailedInfo?e.detailedInfo.fourSquare?g.currentVenueFourSquare(e.detailedInfo.fourSquare):e.detailedInfo.googlePlaces?g.currentVenuePlaces(e.detailedInfo.googlePlaces):g.venueInfoStatus(p):f(e))})};ko.applyBindings(ViewModel);